const { onRequest } = require('firebase-functions/v2/https');
const { getFirestore } = require('firebase-admin/firestore');

// Firebase AdminÏùÄ index.jsÏóêÏÑú Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎê®
const db = getFirestore();

const SITE_URL = 'https://marlang-app.web.app';

// HTML ÌÖúÌîåÎ¶ø ÏÉùÏÑ± Ìï®Ïàò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
function generateArticleHTML(article) {
    const cleanSummary = (article.summary || '').replace(/"/g, '&quot;').substring(0, 160);
    const cleanTitle = (article.title || '').replace(/"/g, '&quot;');
    const publishDate = new Date(article.publishedAt).toLocaleDateString('ko-KR');

    return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${cleanTitle} - NEWStep Eng News</title>
    
    <!-- Google AdSense verification -->
    <meta name="google-adsense-account" content="ca-pub-6930662244421305">
    
    <!-- SEO Î©îÌÉÄ ÌÉúÍ∑∏ -->
    <meta name="description" content="${cleanSummary}">
    <meta name="keywords" content="ÏòÅÏñ¥ Îâ¥Ïä§, ${article.category}, English News, English Learning, ${cleanTitle}">
    <meta name="author" content="NEWStep Team">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph -->
    <meta property="og:title" content="${cleanTitle} - NEWStep Eng News">
    <meta property="og:description" content="${cleanSummary}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="${SITE_URL}/article/${article.id}">
    <meta property="og:site_name" content="NEWStep Eng News">
    <meta property="og:image" content="${article.image || article.imageUrl || article.urlToImage || `${SITE_URL}/newstep-social-image.jpg`}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@NEWStepNews">
    <meta name="twitter:creator" content="@NEWStepNews">
    <meta name="twitter:title" content="${cleanTitle}">
    <meta name="twitter:description" content="${cleanSummary}">
    <meta name="twitter:image" content="${article.image || article.imageUrl || article.urlToImage || `${SITE_URL}/newstep-social-image.jpg`}">
    <meta name="twitter:image:alt" content="${cleanTitle}">
    
    <!-- Íµ¨Ï°∞ÌôîÎêú Îç∞Ïù¥ÌÑ∞ (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "${cleanTitle}",
      "description": "${cleanSummary}",
      "author": {
        "@type": "Organization",
        "name": "NEWStep Team"
      },
      "publisher": {
        "@type": "Organization",
        "name": "NEWStep Eng News",
        "url": "${SITE_URL}",
        "logo": {
          "@type": "ImageObject",
          "url": "${SITE_URL}/icon-192.png"
        }
      },
      "datePublished": "${article.publishedAt}",
      "dateModified": "${article.updatedAt || article.publishedAt}",
      "articleSection": "${article.category}",
      "url": "${SITE_URL}/article/${article.id}",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "${SITE_URL}/article/${article.id}"
      }
      ${article.image ? `,"image": ["${article.image}"]` : ''}
    }
    </script>
    
    <!-- Ïπ¥Ïπ¥Ïò§ Ïï†ÎìúÌïè Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script async src="//t1.daumcdn.net/kas/static/ba.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6; 
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f8f9fa;
        }
        
        .page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            min-height: 100vh;
        }
        
        .article-image { 
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 1rem;
        }
        
        .article-meta { 
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .article-title { 
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            line-height: 1.3;
            color: #333;
        }
        
        .date-text {
            color: #666;
            font-size: 0.9rem;
        }
        
        .category-tag { 
            background: #e3f2fd; 
            color: #1976d2; 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .content-card {
            background: #fff;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
        }
        
        .content-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
        }
        
        .ad-container {
            margin: 2rem 0;
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .ad-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .page-container { 
                padding: 15px; 
            }
            
            .article-title { 
                font-size: 1.6rem;
            }
            
            .article-image {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <article itemscope itemtype="https://schema.org/NewsArticle">
            ${article.image ? `<img src="${article.image}" alt="${cleanTitle}" class="article-image" itemprop="image" crossorigin="anonymous" onerror="this.style.display='none'">` : ''}
            
            <div class="article-meta">
                <span class="category-tag" itemprop="articleSection">${article.category}</span>
                <span class="date-text">
                    <time datetime="${article.publishedAt}" itemprop="datePublished">${publishDate}</time>
                </span>
                ${article.views ? `<span class="date-text">üëÅ ${article.views} views</span>` : ''}
            </div>
            
            <h1 class="article-title" itemprop="headline">${cleanTitle}</h1>
            
            <div class="content-card">
                <div class="content-text" itemprop="articleBody">
                    <p><strong>üìù ÏöîÏïΩ:</strong> <span itemprop="description">${article.summary || 'ÏòÅÏñ¥ Îâ¥Ïä§Î•º ÌÜµÌï¥ ÏòÅÏñ¥ Ïã§Î†•ÏùÑ Ìñ•ÏÉÅÏãúÏºúÎ≥¥ÏÑ∏Ïöî.'}</span></p>
                    
                    ${article.content ? `
                    <div style="margin-top: 1.5rem;">
                        <div class="article-content-text">
                            ${typeof article.content === 'string' ? article.content.replace(/\n/g, '<br>') :
                (article.content.beginner || article.content.intermediate || article.content.advanced || JSON.stringify(article.content))}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Í¥ëÍ≥† ÏòÅÏó≠ -->
            <div class="ad-container">
                <div class="ad-label">Í¥ëÍ≥†</div>
                <ins class="kakao_ad_area" 
                     style="display:block;" 
                     data-ad-unit="DAN-JVIJRJhlqIMMpiLm" 
                     data-ad-width="728" 
                     data-ad-height="90"></ins>
                <script type="text/javascript">
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
            
            <!-- Î™®Î∞îÏùº Í¥ëÍ≥† -->
            <div class="ad-container" style="display: none;">
                <div class="ad-label">Í¥ëÍ≥†</div>
                <ins class="kakao_ad_area" 
                     style="display:block;" 
                     data-ad-unit="DAN-RNzVkjnBfLSGDxqM" 
                     data-ad-width="320" 
                     data-ad-height="50"></ins>
            </div>
            
            <script>
                // Î™®Î∞îÏùº Í∞êÏßÄ Î∞è Í¥ëÍ≥† ÌëúÏãú
                if (window.innerWidth <= 768) {
                    document.querySelectorAll('.ad-container')[0].style.display = 'none';
                    document.querySelectorAll('.ad-container')[1].style.display = 'block';
                }
            </script>
        </article>
    </div>
    
    <!-- React Ïï± ÎßàÏö¥Ìä∏ Ìè¨Ïù∏Ìä∏ -->
    <div id="root"></div>
    
    <!-- ÌîÑÎ¶¨Î†åÎçî Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï -->
    <script>
        window.__PRERENDERED_ARTICLE__ = {
            id: '${article.id}',
            title: '${cleanTitle}',
            summary: '${(article.summary || '').replace(/'/g, "\\'")}',
            category: '${article.category || 'General'}',
            publishedAt: '${article.publishedAt}',
            image: '${article.image || ''}',
            content: ${JSON.stringify(article.content || '')},
            contentType: '${typeof article.content}',
            hasStructuredContent: ${!!(article.content && typeof article.content === 'object')},
            isPrerendered: true,
            _metadata: {
                generatedAt: '${new Date().toISOString()}',
                version: '1.0',
                source: 'prerender'
            }
        };
        
        // React Ïï± Î°úÎìú ÌõÑ Ï†ïÏ†Å ÏΩòÌÖêÏ∏† Ïà®ÍπÄ
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const reactRoot = document.querySelector('#root > div');
                if (reactRoot && reactRoot.children.length > 0) {
                    document.querySelector('.page-container').style.display = 'none';
                }
            }, 1000);
        });
    </script>
    
    <!-- React Ïï± Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script type="module" crossorigin src="/assets/js/index-Bb0Hm0T9.js"></script>
    <link rel="modulepreload" crossorigin href="/assets/js/react-vendor-Dz8DRwSR.js">
    <link rel="modulepreload" crossorigin href="/assets/js/mui-core-CgHrKOaS.js">
</body>
</html>`;
}

// 404 ÌéòÏù¥ÏßÄ HTML
function generateNotFoundHTML(articleId) {
    return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏∞ÏÇ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ - NEWStep Eng News</title>
    <meta name="robots" content="noindex">
</head>
<body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
    <h1>üîç Í∏∞ÏÇ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h1>
    <p>ÏöîÏ≤≠ÌïòÏã† Í∏∞ÏÇ¨(ID: ${articleId})Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
    <a href="${SITE_URL}" style="color: #1976d2;">ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
    <div id="root"></div>
    <script type="module" crossorigin src="/assets/js/index-Bb0Hm0T9.js"></script>
    <link rel="modulepreload" crossorigin href="/assets/js/react-vendor-Dz8DRwSR.js">
    <link rel="modulepreload" crossorigin href="/assets/js/mui-core-CgHrKOaS.js">
</body>
</html>`;
}

// ÏÜåÏÖú ÌÅ¨Î°§Îü¨ Í∞êÏßÄ Ìï®Ïàò
const isSocialCrawler = (userAgent) => {
  if (!userAgent) return false;
  
  const ua = userAgent.toLowerCase();
  const crawlers = [
    'facebookexternalhit', 'facebookcatalog', 'facebookbot',
    'twitterbot', 'linkedinbot', 'whatsappbot', 'telegrambot',
    'discordbot', 'slackbot', 'googlebot', 'bingbot', 'applebot', 'threadsbot', 'threads'
  ];
  
  return crawlers.some(crawler => ua.includes(crawler));
};

// ÌÅ¨Î°§Îü¨ ÌÉÄÏûÖ Í∞êÏßÄ Ìï®Ïàò
const detectCrawlerType = (userAgent) => {
  const ua = userAgent.toLowerCase();
  
  if (ua.includes('facebookexternalhit') || ua.includes('facebookbot')) return 'facebook';
  if (ua.includes('twitterbot')) return 'twitter';
  if (ua.includes('threads')) return 'threads';
  if (ua.includes('linkedinbot')) return 'linkedin';
  if (ua.includes('whatsapp')) return 'whatsapp';
  if (ua.includes('telegram')) return 'telegram';
  if (ua.includes('discord')) return 'discord';
  if (ua.includes('googlebot')) return 'google';
  
  return 'unknown';
};

// Í∞úÏÑ†Îêú Í∏∞ÏÇ¨ ÌîÑÎ¶¨Î†åÎçîÎßÅ Ìï®Ïàò
const prerenderArticle = onRequest(
  {
    region: 'asia-northeast3',
    memory: '1GiB',
    timeoutSeconds: 60,
    cors: true
  },
  async (req, res) => {
    const startTime = Date.now();
    
    try {
      // CORS Ìó§Îçî ÏÑ§Ï†ï
      res.set('Access-Control-Allow-Origin', '*');
      res.set('Access-Control-Allow-Methods', 'GET, OPTIONS');
      res.set('Access-Control-Allow-Headers', 'Content-Type');
      
      if (req.method === 'OPTIONS') {
        res.status(204).send('');
        return;
      }
      
      if (req.method !== 'GET') {
        res.status(405).send('Method Not Allowed');
        return;
      }
      
      // URLÏóêÏÑú Í∏∞ÏÇ¨ ID Ï∂îÏ∂ú
      const urlPath = req.path || req.url || '';
      console.log(`üîç ÏöîÏ≤≠ URL: ${urlPath}`);
      
      const articleIdMatch = urlPath.match(/\/article\/([^\/\?&#]+)/);
      
      if (!articleIdMatch) {
        console.error('‚ùå Í∏∞ÏÇ¨ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', urlPath);
        res.status(404).send(generateNotFoundHTML('unknown'));
        return;
      }
      
      const articleId = decodeURIComponent(articleIdMatch[1]);
      console.log(`üîç Í∏∞ÏÇ¨ ÌîÑÎ¶¨Î†åÎçîÎßÅ ÏöîÏ≤≠: ${articleId}`);
      
      // User-Agent ÌôïÏù∏
      const userAgent = req.get('User-Agent') || '';
      const isCrawler = isSocialCrawler(userAgent);
      const crawlerType = isCrawler ? detectCrawlerType(userAgent) : null;
      
      console.log(`ü§ñ ÏöîÏ≤≠ Î∂ÑÏÑù: ${isCrawler ? `ÌÅ¨Î°§Îü¨(${crawlerType})` : 'ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê'}`);
      
      // FirestoreÏóêÏÑú Í∏∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (ID Ï†ïÍ∑úÌôî Ìè¨Ìï®)
      let article = null;
      
      // ÏõêÎ≥∏ ID Ïô∏ÏóêÎèÑ Ïä¨Îü¨Í∑∏/Ïñ∏ÎçîÎ∞î/ÎåÄÏãú Îí§ ÌÜ†ÌÅ∞, Ïà´Ïûê ÌÜ†ÌÅ∞ Îì±ÏùÑ ÌõÑÎ≥¥Î°ú ÏãúÎèÑ
      const normalizeArticleId = (raw) => {
        const candidates = [raw];
        // Ïñ∏ÎçîÎ∞î/ÎåÄÏãúÍ∞Ä ÏûàÏúºÎ©¥ ÎßàÏßÄÎßâ ÌÜ†ÌÅ∞ ÏãúÎèÑ
        if (raw.includes('_') || raw.includes('-')) {
          const lastToken = raw.split(/[_-]/).pop();
          if (lastToken && !candidates.includes(lastToken)) candidates.push(lastToken);
        }
        // Í∏∏Ïù¥ 8+ Ïà´Ïûê ÌÜ†ÌÅ∞ ÏãúÎèÑ
        const numericMatch = raw.match(/(\d{8,})/);
        if (numericMatch && !candidates.includes(numericMatch[1])) {
          candidates.push(numericMatch[1]);
        }
        return candidates;
      };

      try {
        const candidateIds = normalizeArticleId(articleId);
        console.log('üîç ID ÌõÑÎ≥¥Íµ∞:', candidateIds);
        let articleDoc = null;
        let usedId = null;
        for (const cid of candidateIds) {
          console.log(`üìä Firestore Ï°∞Ìöå ÏãúÎèÑ: articles/${cid}`);
          const docSnap = await db.collection('articles').doc(cid).get();
          if (docSnap.exists) {
            articleDoc = docSnap;
            usedId = cid;
            break;
          }
        }
        if (!articleDoc) {
          console.warn(`‚ö†Ô∏è Í∏∞ÏÇ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${articleId}`);
          res.status(404).send(generateNotFoundHTML(articleId));
          return;
        }
        
        const articleData = articleDoc.data();
        console.log(`üìä Í∏∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ÏôÑÎ£å: ${articleData.title} (ÏÉÅÌÉú: ${articleData.status})`);
        
        // Î∞úÌñâÎêú Í∏∞ÏÇ¨Îßå ÌîÑÎ¶¨Î†åÎçîÎßÅ
        if (articleData.status !== 'published') {
          console.warn(`‚ö†Ô∏è ÎØ∏Î∞úÌñâ Í∏∞ÏÇ¨: ${articleId} (ÏÉÅÌÉú: ${articleData.status})`);
          res.status(404).send(generateNotFoundHTML(articleId));
          return;
        }
        
        article = {
          id: usedId,
          ...articleData,
          image: articleData.image || articleData.imageUrl || articleData.urlToImage || null
        };
        
        console.log(`‚úÖ Í∏∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${article.title}`);
        
        // Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä (ÎπÑÎèôÍ∏∞)
        db.collection('articles').doc(usedId).update({
          views: (articleData.views || 0) + 1,
          updatedAt: new Date().toISOString()
        }).catch(error => {
          console.warn('Ï°∞ÌöåÏàò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
        });
        
      } catch (firestoreError) {
        console.error('‚ùå Firestore Ï°∞Ìöå Ïã§Ìå®:', firestoreError);
        
        // Firestore Ïò§Î•ò ÏãúÏóêÎèÑ React Ïï±Ïù¥ Î°úÎìúÎêòÎèÑÎ°ù Í∏∞Î≥∏ HTML Î∞òÌôò
        const errorHtml = `
          <!DOCTYPE html>
          <html lang="ko">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Í∏∞ÏÇ¨ Î°úÎî© Ï§ë... - NEWStep Eng News</title>
          </head>
          <body>
            <div style="padding: 20px; text-align: center;">
              <h1>Í∏∞ÏÇ¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</h1>
              <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</p>
            </div>
            <div id="root"></div>
            <script>
              window.__ARTICLE_LOAD_ERROR__ = {
                articleId: '${articleId}',
                error: 'firestore_error',
                timestamp: '${new Date().toISOString()}'
              };
            </script>
            <script type="module" crossorigin src="/assets/js/index-Bb0Hm0T9.js"></script>
            <link rel="modulepreload" crossorigin href="/assets/js/react-vendor-Dz8DRwSR.js">
            <link rel="modulepreload" crossorigin href="/assets/js/mui-core-CgHrKOaS.js">
          </body>
          </html>
        `;
        
        res.status(500).send(errorHtml);
        return;
      }
      
      // HTML ÏÉùÏÑ± Î∞è ÏùëÎãµ
      const html = generateArticleHTML(article);
      
      // Ï∫êÏãú Ìó§Îçî ÏÑ§Ï†ï
      if (isCrawler) {
        res.set('Cache-Control', 'public, max-age=3600, s-maxage=7200');
      } else {
        res.set('Cache-Control', 'public, max-age=300, s-maxage=600');
      }
      
      res.set('Content-Type', 'text/html; charset=utf-8');
      
      const processingTime = Date.now() - startTime;
      console.log(`‚úÖ ÌîÑÎ¶¨Î†åÎçîÎßÅ ÏôÑÎ£å: ${articleId} (${processingTime}ms)`);
      
      res.send(html);
      
    } catch (error) {
      console.error('‚ùå ÌîÑÎ¶¨Î†åÎçîÎßÅ Ïò§Î•ò:', error);
      const processingTime = Date.now() - startTime;
      console.log(`‚ùå ÌîÑÎ¶¨Î†åÎçîÎßÅ Ïã§Ìå®: ${processingTime}ms`);
      
      const errorHtml = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Ïò§Î•ò Î∞úÏÉù - NEWStep Eng News</title>
        </head>
        <body>
          <div style="padding: 20px; text-align: center;">
            <h1>ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</h1>
            <p>ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.</p>
            <button onclick="window.location.reload()" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 5px; cursor: pointer;">ÏÉàÎ°úÍ≥†Ïπ®</button>
          </div>
          <div id="root"></div>
          <script>
            window.__PRERENDER_ERROR__ = {
              error: 'server_error',
              timestamp: '${new Date().toISOString()}'
            };
          </script>
          <script type="module" crossorigin src="/assets/js/index-Bb0Hm0T9.js"></script>
          <link rel="modulepreload" crossorigin href="/assets/js/react-vendor-Dz8DRwSR.js">
          <link rel="modulepreload" crossorigin href="/assets/js/mui-core-CgHrKOaS.js">
        </body>
        </html>
      `;
      
      res.status(500).send(errorHtml);
    }
  }
);

module.exports = { prerenderArticle };